[TOC]
## 浏览器缓存
### 浏览器缓存的过程
浏览器在第一次向服务器发起该请求，获取到请求结果后，浏览器会根据响应报文中HTTP头的缓存标识(`比如：Expires，Cache-Control，Last-Modified， ETag`)，来决定是否将请求结果进行缓存，如果要，那么就将请求结果和缓存标识存入浏览器缓存中。
下一次的发送请求时，会优先从浏览器缓存中进行查找，如果命中缓存，则直接返回结果，如果没有命中，则再向服务器发送请求，获取到返回结果后，再进行判断是否将请求结果保持到缓存。

### 浏览器缓存的机制

#### 强制缓存
`强制缓存`：即不会向服务器发送请求，直接从缓存中读取资源。

```
// 设置
# HTTP 1.0 使用 Expires 来进行设置 (过时)
Expires为过期时间，在服务器返回的响应头中，告诉浏览器在过期时间前浏览器无需再次请求，直接从浏览器缓存中获取取数据。弊端是当服务器的时间和浏览器的时间不一致时，缓存就会失效。

# HTTP 1.1 使用 Cache-Control 来进行设置(现阶段)
例如：Cache-Control:max-age=3600，代表浏览器接收到这个响应后的 3600 秒，也就是一个小时之内可以直接使用缓存。
# Cache-Control 搭配指令
Cache-Control 可以在请求头或者响应头中搭配多种指令，完成更多场景的缓存判断。
public：所有内容都将被缓存（客户端和代理服务器都可缓存）。
private：所有内容只有客户端可以缓存，Cache-Control的默认取值。
no-cache: 跳过当前的强缓存，是否使用缓存则需要经过协商缓存来验证决定，设置了no-cache后，并不是说浏览器就不再缓存数据，只是浏览器在使用缓存数据时，需要先确认一下数据是否还跟服务器保持一致。
no-store：不适用任何形式的缓存，即不用强制缓存，也不用协商缓存。
max-age：max-age=3600 表示缓存内容将在3600秒后失效。
s-maxage（s)：s-maxage=60，表示缓存内容将在60秒后失效，但它仅针对代理服务器的缓存时间（比如CDN缓存）。s-maxage的优先级高于max-age
max-stale：能容忍的最大过期时间。
```
|指令|作用|
|------------|-----------------------|
|public|所有内容都将被缓存|
|private|所有内容只有客户端可以缓存(默认值)|
|no-cache|是否使用缓存则需要协商缓存决定|
|no-store|不适用任何形式的缓存|
|max-age|缓存内容将在xxx秒后失效|
|s-maxage|缓存内容将在xxx秒后失效(代理服务器)|
|max-stale|最大过期时间|
#### 协商缓存
在强缓存失效之后，浏览器会在请求头中携带相应的缓存标识来向服务器发请求，由服务器根据这个缓存标识，来决定是否使用缓存的过程，这就是`协商缓存`。
```
协商缓存生效，返回304和Not Modified
协商缓存失效，返回200和请求结果
// 协商缓存的标识有两种：Last-Modified 和 ETag 
# Last-Modified
即最后修改时间。在浏览器第一次发送请求给服务器后，服务器会在响应头中添加上这个字段。当浏览器接收到响应头之后，如果再一次发送请求，就会在请求头中携带`If-Modified-Since`字段，值就是Last-Modified中的值。服务器再次收到这个资源请求，会根据 If-Modified-Since 中的值与服务器中这个资源的最后修改时间对比，如果没有变化，返回304和空的响应体，直接从缓存读取，如果If-Modified-Since的时间小于服务器中这个资源的最后修改时间，说明文件有更新，于是返回新的资源文件和200。

# ETag
ETag 是服务器根据当前文件的内容，给文件生成的唯一标识，只要里面的内容有改动，这个值就会变。服务器通过响应头把这个值给浏览器。浏览器接收到ETag的值，会在下次请求时，将这个值作为`If-None-Match`这个字段的内容，并放到请求头中，然后发给服务器。服务器接收到If-None-Match后，会跟服务器上该资源的ETag进行比对。如果ETag是一致的，则直接返回304，告诉浏览器直接用缓存，如果不一致则正常请求。

# Last-Modified 和 ETag 两者对比
精确度，Etag要优于Last-Modified；
性能上，Last-Modified要优于Etag；
优先级，服务端优先使用ETag；
```
### 浏览器缓存的位置
#### Service Worker
`Service Worker`是借鉴`Web Worker`而来的，是运行在浏览器背后的一个独立线程，因此无法访问DOM，但能帮助做很多有用的功能，比如`拦截客户端请求`，`向客户端推送消息`，，`网络代理向服务器发送请求`，`离线缓存`等。
使用 Service Worker的话，传输协议必须为https。因为 Service Worker 中涉及到请求拦截，所以必须使用 https 协议来保障安全，(本地localhost也可使用)。
#### Memory Cache
即`内存缓存`，主要是当前页面中已经获取到的静态资源，例如css文件，js文件，图片等。虽然内存缓存读效率很高，但缓存的时间短，容量小，因为它会随着进程的释放而释放，例如关闭 Tab标签页，内存中的缓存也就被释放了。
#### Disk Cache
即`磁盘缓存`，相比内存缓存，读效率慢点，但优势是存储的时间和存储的容量比内存缓存好。
#### Push Cache
即`推送缓存`，是 HTTP/2 中的内容，当以上三种缓存都没有命中时，它才会被使用。
